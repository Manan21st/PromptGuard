name: CD Execution

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["CI Execution"]
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      # ----------------------------------------------------
      # 1. Checkout source code
      # ----------------------------------------------------
      - name: Checkout source code
        uses: actions/checkout@v4

      # ----------------------------------------------------
      # 2. Create Kubernetes cluster using kind
      # ----------------------------------------------------
      - name: Set up Kubernetes cluster (kind)
        uses: helm/kind-action@v1.10.0
        with:
          cluster_name: promptguard

      # ----------------------------------------------------
      # 3. Verify kind cluster
      # ----------------------------------------------------
      - name: Verify kind cluster
        run: |
          kind get clusters
          kubectl get nodes

      # ----------------------------------------------------
      # 4. Pull CI-built Docker image
      # ----------------------------------------------------
      - name: Pull Docker image
        run: |
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/promptguard:${{ github.event.workflow_run.head_sha }}

      # ----------------------------------------------------
      # 5. Load Docker image into kind cluster
      # ----------------------------------------------------
      - name: Load image into kind
        run: |
          kind load docker-image \
            ${{ secrets.DOCKERHUB_USERNAME }}/promptguard:${{ github.event.workflow_run.head_sha }} \
            --name promptguard

      # ----------------------------------------------------
      # 6. Deploy application to Kubernetes
      # ----------------------------------------------------
      - name: Deploy to Kubernetes
        run: |
          sed -e "s|IMAGE_PLACEHOLDER|${{ secrets.DOCKERHUB_USERNAME }}/promptguard:${{ github.event.workflow_run.head_sha }}|g" \
              -e "s|value: \"dummy\"|value: \"${{ secrets.GEMINI_API_KEY }}\"|g" \
              k8s/deployment.yaml | kubectl apply -f -
          kubectl apply -f k8s/service.yaml

      # ----------------------------------------------------
      # 7. Wait for deployment rollout
      # ----------------------------------------------------
      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/promptguard --timeout=120s

      # ----------------------------------------------------
      # 8. Port forward service
      # ----------------------------------------------------
      - name: Port forward service
        run: |
          kubectl port-forward svc/promptguard-service 18080:80 &
          sleep 10

      # ----------------------------------------------------
      # 9. Validate application health
      # ----------------------------------------------------
      - name: Validate health endpoint
        run: |
          curl -f http://localhost:18080/health/

      # ----------------------------------------------------
      # 10. Optional smoke test with Gemini API
      # ----------------------------------------------------
      - name: Optional Gemini smoke test
        continue-on-error: true
        run: |
          curl -X POST http://localhost:18080/evaluate/ \
          -H "Content-Type: application/json" \
          -d '{"prompt":"Say hello politely"}'

