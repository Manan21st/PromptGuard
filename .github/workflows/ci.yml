name: CI Execution

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  ci-pipeline:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      security-events: write

    steps:
      # ----------------------------------------------------
      # 1. Checkout
      # ----------------------------------------------------
      - name: Checkout source code
        uses: actions/checkout@v4

      # ----------------------------------------------------
      # 2. Setup Python 3.11                             manan
      # ----------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ----------------------------------------------------
      # 3. Install dependencies
      # ----------------------------------------------------
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # ----------------------------------------------------
      # 4. Code Quality – Linting (Ruff)
      # ----------------------------------------------------
      - name: Run Ruff linting
        run: |
          ruff check src

      # ----------------------------------------------------
      # 5. SAST – CodeQL (Python)
      # ----------------------------------------------------
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: python

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

      # ----------------------------------------------------
      # 6. SCA – Dependency Vulnerability Scan
      # ----------------------------------------------------
      - name: Dependency vulnerability scan (pip-audit)
        run: |
          pip-audit

      # ----------------------------------------------------
      # 7. Unit Tests (mocked, no secrets)
      # ----------------------------------------------------
      - name: Run pytest
        env:
          PYTHONPATH: .
        run: |
          pytest

      # ----------------------------------------------------
      # 8. Docker Build                              manan
      # ----------------------------------------------------
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          docker build \
            -t ${{ secrets.DOCKERHUB_USERNAME }}/promptguard:latest \
            -t ${{ secrets.DOCKERHUB_USERNAME }}/promptguard:${{ github.sha }} \
            .

      # ----------------------------------------------------
      # 9. Trivy – Container Vulnerability Scan
      # ----------------------------------------------------
      - name: Run Trivy vulnerability scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ secrets.DOCKERHUB_USERNAME }}/promptguard:${{ github.sha }}
          format: sarif
          output: trivy-results.sarif
          severity: CRITICAL,HIGH
          exit-code: 0

      - name: Upload Trivy scan results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-results.sarif

      # ----------------------------------------------------
      # 10. Login to DockerHub
      # ----------------------------------------------------
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # ----------------------------------------------------
      # 11. Push Docker Images
      # ----------------------------------------------------
      - name: Push Docker images
        run: |
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/promptguard:latest
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/promptguard:${{ github.sha }}
